# ğŸ“¦ Project Initialization Plan

**Generated by:** Claude (claude-sonnet-4-5-20250929)
**Date:** 2025-11-08
**Status:** Implementation guide

---

## Cargo Workspace Structure

Simple workspace: plugin crate + example demonstrating the CRT character concept.

```
halfremembered-bevy-alacritty/
â”œâ”€â”€ Cargo.toml                    # Workspace root
â”œâ”€â”€ Cargo.lock                    # Locked dependencies (track in git)
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .rustfmt.toml
â”œâ”€â”€ .cargo/
â”‚   â””â”€â”€ config.toml              # Build optimizations
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci.yml               # CI/CD
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ BOTS.md                       # Agent instructions
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ technical-design.md
â”‚   â””â”€â”€ plan-bootstrap/
â”‚       â”œâ”€â”€ 00-overview.md
â”‚       â”œâ”€â”€ 01-project-initialization.md
â”‚       â””â”€â”€ ...
â”œâ”€â”€ bevy-terminal/                # The plugin crate
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib.rs               # Plugin entry, exports
â”‚   â”‚   â”œâ”€â”€ terminal.rs          # Plugin definition
â”‚   â”‚   â”œâ”€â”€ pty.rs               # PTY lifecycle (persistent)
â”‚   â”‚   â”œâ”€â”€ renderer.rs          # Render-to-texture system
â”‚   â”‚   â”œâ”€â”€ font.rs              # Font loading
â”‚   â”‚   â”œâ”€â”€ atlas.rs             # Glyph atlas generation
â”‚   â”‚   â”œâ”€â”€ input.rs             # Keyboard handling
â”‚   â”‚   â”œâ”€â”€ events.rs            # Event types
â”‚   â”‚   â””â”€â”€ colors.rs            # Tokyo Night (hardcoded)
â”‚   â””â”€â”€ assets/
â”‚       â””â”€â”€ fonts/
â”‚           â”œâ”€â”€ CascadiaMono-Regular.ttf
â”‚           â”œâ”€â”€ CascadiaMono-Bold.ttf      # Future
â”‚           â””â”€â”€ CascadiaMono-Italic.ttf    # Future
â””â”€â”€ examples/
    â””â”€â”€ claude_crt/              # CRT character example
        â”œâ”€â”€ Cargo.toml
        â””â”€â”€ src/
            â””â”€â”€ main.rs          # Tiny CRT head â†’ fullscreen demo
```

## Root Workspace Cargo.toml

```toml
[workspace]
members = [
    "bevy-terminal",
    "examples/claude_crt",
]
resolver = "2"

[workspace.package]
version = "0.1.0"
edition = "2021"
rust-version = "1.75"  # Bevy 0.17 minimum
authors = ["Your Name <your@email.com>"]
license = "MIT OR Apache-2.0"

[workspace.dependencies]
# Core engine
bevy = { version = "0.17", default-features = false }

# Terminal emulation
alacritty_terminal = "0.25"
vte = "0.13"

# PTY management
portable-pty = "0.8"

# Font rendering
ab_glyph = "0.2"

# Error handling
anyhow = "1.0"
thiserror = "2.0"

# Utilities
log = "0.4"

[profile.dev]
opt-level = 1  # Better dev performance

[profile.dev.package."*"]
opt-level = 3  # Fast dependencies in dev

[profile.release]
lto = "thin"
codegen-units = 1
strip = true
```

## Plugin Crate: bevy-terminal/Cargo.toml

```toml
[package]
name = "bevy-terminal"
version.workspace = true
edition.workspace = true
rust-version.workspace = true
authors.workspace = true
license.workspace = true
description = "Bevy plugin for embedding terminal emulation via render-to-texture"
repository = "https://github.com/yourusername/halfremembered-bevy-alacritty"
keywords = ["bevy", "terminal", "emulator", "game", "pty"]
categories = ["game-development", "emulators"]

[dependencies]
# Bevy with features for quality rendering
bevy = { workspace = true, features = [
    "bevy_asset",
    "bevy_sprite",
    "bevy_text",
    "bevy_ui",
    "bevy_render",
    "bevy_core_pipeline",
    "png",
    "multi_threaded",
] }

# Terminal emulation
alacritty_terminal = { workspace = true }
vte = { workspace = true }

# PTY management
portable-pty = { workspace = true }

# Font rendering
ab_glyph = { workspace = true }

# Error handling
anyhow = { workspace = true }
thiserror = { workspace = true }

# Utilities
log = { workspace = true }

[dev-dependencies]
bevy = { workspace = true, default-features = true }

[features]
default = []
# Future: ligatures, emoji, scrollback
```

## Example: examples/claude_crt/Cargo.toml

```toml
[package]
name = "claude_crt"
version.workspace = true
edition.workspace = true
rust-version.workspace = true
publish = false

[dependencies]
bevy = { workspace = true, default-features = true }
bevy-terminal = { path = "../../bevy-terminal" }
anyhow = { workspace = true }
```

## Initial Source Files

### bevy-terminal/src/lib.rs

```rust
//! Bevy plugin for embedding terminal emulation in games.
//!
//! Uses render-to-texture architecture for flexible display:
//! - Terminal renders to `Image` texture
//! - Texture can be used as sprite, UI, or material
//! - Supports multiple views (tiny CRT head, fullscreen overlay)
//! - Persistent PTY lifecycle (always running in background)
//!
//! # Example
//! ```no_run
//! use bevy::prelude::*;
//! use bevy_terminal::prelude::*;
//!
//! fn main() {
//!     App::new()
//!         .add_plugins(DefaultPlugins)
//!         .add_plugins(TerminalPlugin)
//!         .run();
//! }
//!
//! fn use_terminal(terminal_texture: Res<TerminalTexture>) {
//!     // terminal_texture.handle is Handle<Image>
//!     // Use it anywhere: sprites, UI, materials
//! }
//! ```

use bevy::prelude::*;

mod atlas;
mod colors;
mod events;
mod font;
mod input;
mod pty;
mod renderer;
mod terminal;

pub use terminal::TerminalPlugin;
pub use renderer::TerminalTexture;

/// Re-export commonly used types
pub mod prelude {
    pub use crate::terminal::TerminalPlugin;
    pub use crate::renderer::TerminalTexture;
    pub use crate::events::TerminalEvent;
}
```

### bevy-terminal/src/terminal.rs

```rust
//! Core terminal plugin definition.

use bevy::prelude::*;

/// Bevy plugin for terminal emulation.
///
/// MVP: Hardcoded configuration
/// - Font: Cascadia Mono Regular, 14pt
/// - Size: 120 cols Ã— 30 rows
/// - Colors: Tokyo Night
/// - Shell: bash (or default shell)
///
/// PTY is spawned in Startup system and runs persistently.
/// Terminal state updates continuously in background.
/// Renders to texture exposed via `TerminalTexture` resource.
pub struct TerminalPlugin;

impl Plugin for TerminalPlugin {
    fn build(&self, app: &mut App) {
        info!("ğŸ–¥ï¸  Initializing TerminalPlugin (render-to-texture)");

        app
            // TODO: Add resources
            // .init_resource::<TerminalState>()
            // .init_resource::<TerminalTexture>()
            // .init_resource::<GlyphAtlas>()

            // TODO: Add systems
            // .add_systems(Startup, spawn_pty)
            // .add_systems(Update, (
            //     poll_pty,
            //     update_terminal_grid,
            //     render_to_texture,
            //     handle_input,
            // ))

            // TODO: Add events
            // .add_event::<TerminalEvent>()
            ;

        info!("âœ… TerminalPlugin initialized");
    }
}

impl Default for TerminalPlugin {
    fn default() -> Self {
        Self
    }
}
```

### bevy-terminal/src/colors.rs

```rust
//! Terminal color schemes.
//!
//! MVP: Hardcoded Tokyo Night theme

use bevy::prelude::*;

/// Tokyo Night color scheme (hardcoded for MVP)
#[derive(Debug, Clone)]
pub struct TokyoNightColors {
    pub background: Color,
    pub foreground: Color,
    // Standard ANSI colors (0-7)
    pub black: Color,
    pub red: Color,
    pub green: Color,
    pub yellow: Color,
    pub blue: Color,
    pub magenta: Color,
    pub cyan: Color,
    pub white: Color,
    // Bright ANSI colors (8-15)
    pub bright_black: Color,
    pub bright_red: Color,
    pub bright_green: Color,
    pub bright_yellow: Color,
    pub bright_blue: Color,
    pub bright_magenta: Color,
    pub bright_cyan: Color,
    pub bright_white: Color,
}

impl Default for TokyoNightColors {
    fn default() -> Self {
        Self {
            background: Color::srgb_u8(0x16, 0x16, 0x1e),
            foreground: Color::srgb_u8(0xc0, 0xca, 0xf5),
            black: Color::srgb_u8(0x15, 0x16, 0x1e),
            red: Color::srgb_u8(0xf7, 0x76, 0x8e),
            green: Color::srgb_u8(0x9e, 0xce, 0x6a),
            yellow: Color::srgb_u8(0xe0, 0xaf, 0x68),
            blue: Color::srgb_u8(0x7a, 0xa2, 0xf7),
            magenta: Color::srgb_u8(0xbb, 0x9a, 0xf7),
            cyan: Color::srgb_u8(0x7d, 0xcf, 0xff),
            white: Color::srgb_u8(0xa9, 0xb1, 0xd6),
            bright_black: Color::srgb_u8(0x41, 0x48, 0x68),
            bright_red: Color::srgb_u8(0xf7, 0x76, 0x8e),
            bright_green: Color::srgb_u8(0x9e, 0xce, 0x6a),
            bright_yellow: Color::srgb_u8(0xe0, 0xaf, 0x68),
            bright_blue: Color::srgb_u8(0x7a, 0xa2, 0xf7),
            bright_magenta: Color::srgb_u8(0xbb, 0x9a, 0xf7),
            bright_cyan: Color::srgb_u8(0x7d, 0xcf, 0xff),
            bright_white: Color::srgb_u8(0xc0, 0xca, 0xf5),
        }
    }
}
```

### bevy-terminal/src/events.rs

```rust
//! Terminal events.

use bevy::prelude::*;

/// Events emitted by the terminal system
#[derive(Event, Debug)]
pub enum TerminalEvent {
    /// PTY and terminal spawned successfully
    Spawned,
    /// PTY process exited
    ProcessExited { exit_code: Option<i32> },
    /// Error occurred
    Error { message: String },
}
```

### Create Module Skeletons

```rust
// bevy-terminal/src/pty.rs
//! PTY lifecycle management.
//!
//! PTYs are spawned in Startup system and run persistently.

// bevy-terminal/src/renderer.rs
//! Render-to-texture system.
//!
//! Renders terminal grid to Image texture.
//! Exposes Handle<Image> via TerminalTexture resource.

use bevy::prelude::*;

/// Resource exposing the terminal texture for game use
#[derive(Resource)]
pub struct TerminalTexture {
    pub handle: Handle<Image>,
    pub width: u32,
    pub height: u32,
}

// bevy-terminal/src/font.rs
//! Font loading and metrics calculation.

// bevy-terminal/src/atlas.rs
//! Glyph atlas generation for high-quality rendering.

// bevy-terminal/src/input.rs
//! Keyboard input handling.
```

### examples/claude_crt/src/main.rs

```rust
//! Claude CRT Character Example
//!
//! Demonstrates:
//! - Character with CRT head showing real terminal
//! - Terminal texture rendered tiny on sprite
//! - Zoom interaction (E key to fullscreen)
//! - Persistent terminal state

use bevy::prelude::*;
use bevy_terminal::prelude::*;

fn main() {
    App::new()
        .add_plugins(
            DefaultPlugins
                .set(WindowPlugin {
                    primary_window: Some(Window {
                        title: "Claude CRT Character - Terminal Demo".into(),
                        resolution: (1920., 1080.).into(),
                        ..default()
                    }),
                    ..default()
                })
                .set(ImagePlugin::default_nearest()), // Crisp pixels
        )
        .add_plugins(TerminalPlugin)
        .add_systems(Startup, setup)
        .add_systems(Update, (
            toggle_terminal_size,
            update_help_text,
        ))
        .run();
}

#[derive(Component)]
struct ClaudeCharacter;

#[derive(Component)]
struct HelpText;

fn setup(
    mut commands: Commands,
    // terminal_texture: Res<TerminalTexture>, // TODO: Uncomment when ready
) {
    // Camera
    commands.spawn(Camera2d);

    // TODO: Spawn Claude character with CRT head
    // For now, just placeholder
    info!("ğŸ® Claude CRT example ready");
    info!("ğŸ“º Press 'T' to toggle terminal size (not implemented yet)");

    // Help text
    commands.spawn((
        Text::new("Press 'T' to toggle terminal (WIP)"),
        Node {
            position_type: PositionType::Absolute,
            top: Val::Px(10.0),
            left: Val::Px(10.0),
            ..default()
        },
        HelpText,
    ));
}

fn toggle_terminal_size(
    keyboard: Res<ButtonInput<KeyCode>>,
) {
    if keyboard.just_pressed(KeyCode::KeyT) {
        info!("Terminal toggle requested (not implemented)");
        // TODO: Toggle between tiny (0.05) and fullscreen (1.0)
    }
}

fn update_help_text() {
    // TODO: Update help text based on state
}
```

## Font Asset Acquisition

Download Cascadia Mono from Microsoft:

```bash
#!/bin/bash
# scripts/download-fonts.sh

set -e

echo "ğŸ“¥ Downloading Cascadia Code fonts..."

FONTS_DIR="bevy-terminal/assets/fonts"
mkdir -p "$FONTS_DIR"

CASCADIA_VERSION="2404.23"
CASCADIA_URL="https://github.com/microsoft/cascadia-code/releases/download/v${CASCADIA_VERSION}/CascadiaCode-${CASCADIA_VERSION}.zip"

wget -O cascadia-temp.zip "$CASCADIA_URL"
unzip -q cascadia-temp.zip -d cascadia-temp

# Copy Regular (MVP), Bold and Italic (future)
cp cascadia-temp/ttf/CascadiaMono-Regular.ttf "$FONTS_DIR/"
cp cascadia-temp/ttf/CascadiaMono-Bold.ttf "$FONTS_DIR/"
cp cascadia-temp/ttf/CascadiaMono-Italic.ttf "$FONTS_DIR/"

rm -rf cascadia-temp cascadia-temp.zip

echo "âœ… Fonts downloaded:"
ls -lh "$FONTS_DIR"
```

## Development Tools Configuration

### .rustfmt.toml

```toml
edition = "2021"
max_width = 100
tab_spaces = 4
use_small_heuristics = "Max"
imports_granularity = "Crate"
group_imports = "StdExternalCrate"
```

### .cargo/config.toml

```toml
[build]

# Fast linker (Linux)
[target.x86_64-unknown-linux-gnu]
linker = "clang"
rustflags = ["-C", "link-arg=-fuse-ld=lld"]

# Optimize dev builds
[profile.dev]
split-debuginfo = "unpacked"

[alias]
ex = "run --example"
check-all = "clippy --all-targets -- -D warnings"
```

### .github/workflows/ci.yml

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Build
        run: cargo build --verbose --all

      - name: Test
        run: cargo test --verbose --all

      - name: Build examples
        run: cargo build --examples --verbose
```

## Initialization Checklist

Execute in this order:

- [ ] Create directory structure
  ```bash
  mkdir -p bevy-terminal/src bevy-terminal/assets/fonts
  mkdir -p examples/claude_crt/src
  mkdir -p .cargo .github/workflows scripts
  ```

- [ ] Write Cargo.toml files
  - Workspace root
  - bevy-terminal/Cargo.toml
  - examples/claude_crt/Cargo.toml

- [ ] Create initial source files
  - bevy-terminal/src/*.rs (skeletons)
  - examples/claude_crt/src/main.rs

- [ ] Download fonts
  ```bash
  bash scripts/download-fonts.sh
  ```

- [ ] Add config files
  - .rustfmt.toml
  - .cargo/config.toml
  - .github/workflows/ci.yml

- [ ] Update .gitignore
  ```
  target/
  **/*.rs.bk
  *.swp
  .DS_Store
  ```

- [ ] Verify build
  ```bash
  cargo build
  cargo clippy
  cargo test
  cargo run --example claude_crt
  ```

- [ ] Create jj change
  ```bash
  jj new -m "chore: Initialize Cargo workspace and project structure"
  ```

## Build Verification Script

```bash
#!/bin/bash
# scripts/verify-build.sh

set -e

echo "ğŸ” Verifying project setup..."

echo "1ï¸âƒ£  Building..."
cargo build

echo "2ï¸âƒ£  Clippy..."
cargo clippy --all-targets -- -D warnings

echo "3ï¸âƒ£  Format check..."
cargo fmt --check

echo "4ï¸âƒ£  Tests..."
cargo test

echo "5ï¸âƒ£  Example build..."
cargo build --example claude_crt

echo "6ï¸âƒ£  Example run (3s timeout)..."
timeout 3 cargo run --example claude_crt || true

echo "âœ… All checks passed!"
```

## Jujutsu Workflow

```bash
# Start work
jj new -m "chore: Initialize Cargo workspace and project structure"

# Create files, download fonts, etc.

# Test
bash scripts/verify-build.sh

# Update description
jj describe
```

Change description template:
```
chore: Initialize Cargo workspace and project structure

Why: Bootstrap halfremembered-bevy-alacritty with render-to-texture architecture
Approach:
- Workspace with bevy-terminal plugin + claude_crt example
- Hardcoded Tokyo Night colors for MVP speed
- Persistent PTY design (spawn at startup)
- Render-to-texture architecture for flexible display
- Downloaded Cascadia Mono fonts
- CI configured for Linux/Windows/macOS

Status: Complete - builds successfully, example runs

Co-authored-by: Claude <claude@anthropic.com>
```

---

**Next:** See `02-dependencies.md` for detailed dependency analysis
