# ðŸ“š Dependencies Analysis

**Generated by:** Claude (claude-sonnet-4-5-20250929)
**Date:** 2025-11-08
**Status:** Reference guide

---

## Core Dependencies

### Bevy 0.17 (Game Engine)

```toml
bevy = { version = "0.17", features = [
    "bevy_asset",          # Asset loading (fonts)
    "bevy_sprite",         # 2D sprite rendering
    "bevy_text",           # Text rendering utilities
    "bevy_ui",             # UI elements
    "bevy_render",         # Core rendering
    "bevy_core_pipeline",  # Rendering pipeline
    "png",                 # PNG texture support
    "multi_threaded",      # Task pool for async
] }
```

**Why:** Foundation for rendering, ECS, and asset management
**Features:** Only enable what we need (faster compile times)
**Version:** 0.17 required for latest sprite/texture APIs

### alacritty_terminal 0.25 (Terminal Emulation)

```toml
alacritty_terminal = "0.25"
vte = "0.13"  # ANSI parser (used by alacritty)
```

**Why:** Battle-tested terminal emulator backend
**Provides:**
- Terminal grid management (`Term`)
- ANSI/VT sequence parsing
- Text attribute handling (bold, italic, colors)
- Cursor management
- Scrollback buffer

**Usage Pattern:**
```rust
use alacritty_terminal::Term;
use alacritty_terminal::term::Config;

let term = Term::new(
    Config::default(),
    &term_size,
    message_handler,
);
```

### portable-pty 0.8 (PTY Management)

```toml
portable-pty = "0.8"
```

**Why:** Cross-platform PTY creation
**Supports:**
- Unix PTY (Linux, macOS)
- ConPTY (Windows 10+)
- Process spawning (bash, zsh, nvim, etc.)

**Usage Pattern:**
```rust
use portable_pty::{native_pty_system, PtySize, CommandBuilder};

let pty_system = native_pty_system();
let pty_pair = pty_system.openpty(PtySize {
    rows: 30,
    cols: 120,
    pixel_width: 0,
    pixel_height: 0,
})?;

let cmd = CommandBuilder::new("bash");
let child = pty_pair.slave.spawn_command(cmd)?;
```

### ab_glyph 0.2 (Font Rasterization)

```toml
ab_glyph = "0.2"
```

**Why:** High-quality font rendering with control over hinting
**Provides:**
- TTF/OTF parsing
- Glyph rasterization
- Metrics (advance, ascent, descent)
- Subpixel positioning

**Usage Pattern:**
```rust
use ab_glyph::{FontArc, PxScale};

let font = FontArc::try_from_slice(font_bytes)?;
let scale = PxScale::from(14.0);

// Rasterize glyph
let glyph_id = font.glyph_id('A');
let glyph = glyph_id.with_scale(scale);
```

**Quality Settings:**
- No subpixel AA for crisp rendering
- Grayscale AA enabled
- Proper hinting for pixel grid alignment

### Error Handling

```toml
anyhow = "1.0"
thiserror = "2.0"
```

**anyhow:** For application errors (plugin initialization, PTY errors)
**thiserror:** For library errors (custom error types)

**Usage Pattern:**
```rust
use anyhow::{Context, Result};

fn spawn_pty() -> Result<PtyPair> {
    pty_system.openpty(size)
        .context("Failed to create PTY")?;
    // Always add context for debugging
}
```

### Logging

```toml
log = "0.4"
```

**Why:** Bevy uses `log` facade
**Levels:** error, warn, info, debug, trace

**Usage:**
```rust
info!("Terminal spawned with {} cols Ã— {} rows", cols, rows);
debug!("Rendered {} changed cells", dirty_count);
```

## Dependency Tree

```
bevy-terminal
â”œâ”€â”€ bevy 0.17
â”‚   â”œâ”€â”€ (rendering, ECS, assets)
â”‚   â””â”€â”€ Uses tokio internally
â”œâ”€â”€ alacritty_terminal 0.25
â”‚   â””â”€â”€ vte 0.13 (ANSI parser)
â”œâ”€â”€ portable-pty 0.8
â”‚   â””â”€â”€ Platform-specific PTY impl
â”œâ”€â”€ ab_glyph 0.2
â”‚   â””â”€â”€ Font parsing and rasterization
â”œâ”€â”€ anyhow 1.0
â”œâ”€â”€ thiserror 2.0
â””â”€â”€ log 0.4
```

## Platform-Specific Dependencies

### Linux
- `libxcb-shape0-dev`, `libxcb-xfixes0-dev` (X11)
- `libasound2-dev` (audio, even if not used)
- `libudev-dev` (device detection)

### Windows
- ConPTY support (Windows 10+)
- No additional system deps

### macOS
- Core Text (font rendering)
- Standard Unix PTY

## Async I/O Strategy

**Bevy's Async Runtime:**
- Bevy 0.17 includes `bevy_tasks` with async task pool
- Prefer `AsyncComputeTaskPool` for background I/O

**Tokio Integration (if needed):**
```toml
tokio = { version = "1.0", features = ["io-util", "sync"] }
```

**Decision Tree:**
1. Try Bevy's task pool first
2. Check how Alacritty handles PTY I/O (learn from them)
3. Fall back to Tokio if needed

## Future Dependencies (Post-MVP)

### Font Ligatures
```toml
rustybuzz = "0.13"  # Text shaping
unicode-segmentation = "1.10"  # Grapheme clusters
```

### Emoji Support
```toml
# Might need emoji font + color emoji rendering
# Research: swash, skrifa, or custom solution
```

### Clipboard
```toml
arboard = "3.3"  # Cross-platform clipboard
```

## Compile Time Optimization

**Workspace Settings:**
```toml
[profile.dev]
opt-level = 1  # Slightly slower build, faster runtime

[profile.dev.package."*"]
opt-level = 3  # Optimize dependencies
```

**Effect:**
- Faster iteration (dependencies compile once)
- Reasonable dev performance
- Much faster than full opt-level = 3

## Dependency Verification

Check for:
- âœ… **Security:** Use `cargo audit` regularly
- âœ… **Maintenance:** All deps actively maintained
- âœ… **Compatibility:** Bevy 0.17 compatibility
- âœ… **License:** MIT/Apache-2.0 compatible

```bash
# Audit dependencies
cargo install cargo-audit
cargo audit

# Check for updates
cargo install cargo-outdated
cargo outdated

# Dependency tree
cargo tree
```

## Known Issues / Workarounds

### alacritty_terminal
- **Issue:** Grid API can change between minor versions
- **Mitigation:** Pin to exact version, test before upgrading
- **Docs:** Sparse official docs; read Alacritty source code

### portable-pty
- **Issue:** Windows ConPTY requires Windows 10+
- **Mitigation:** Document minimum Windows version
- **Testing:** Test on actual Windows (not WSL)

### Bevy
- **Issue:** Large dependency, slow compile
- **Mitigation:** Minimize feature set, use sccache
- **Workaround:** Consider `bevy_dylib` for faster iteration

---

**Summary:** All dependencies are well-maintained, license-compatible, and suitable for the render-to-texture architecture.
